name: CI

permissions:
  contents: read

on:
  pull_request:
    branches: [ main]

jobs:
  test:
    permissions:
      contents: write
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest black pylint

    - name: Lint Python files
      run: |
        pylint hardware_exporter.py service_manager.py test_fans.py --disable=C0103,C0301,C0114,C0115,C0116
      continue-on-error: true

    - name: Check code formatting with black
      run: |
        black --check *.py
      continue-on-error: true

    - name: Validate Python syntax
      run: |
        python -m py_compile hardware_exporter.py
        python -m py_compile service_manager.py
        python -m py_compile test_fans.py

    - name: Test import statements
      run: |
        python -c "import hardware_exporter; print('OK: hardware_exporter imports successfully')"
        python -c "import argparse, logging, re, time; print('OK: Standard library imports work')"

    - name: Test command line arguments
      run: |
        python hardware_exporter.py --help

    - name: Validate configuration files
      run: |
        if (Test-Path "prometheus_config.txt") { Write-Host "OK: Prometheus config exists" }
        if (Test-Path "grafana_dashboard.json") { Write-Host "OK: Grafana dashboard exists" }
        if (Test-Path "FAN_SUPPORT.md") { Write-Host "OK: Fan support docs exist" }
        if (Test-Path "Install-Rigbeat.bat") { Write-Host "OK: Install script exists" }

  documentation:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Check documentation files
      run: |
        [ -f README.md ] && echo "OK: README.md exists" || echo "ERROR: README.md missing"
        [ -f FAN_SUPPORT.md ] && echo "OK: FAN_SUPPORT.md exists" || echo "ERROR: FAN_SUPPORT.md missing"
        [ -f LICENSE ] && echo "OK: LICENSE exists" || echo "ERROR: LICENSE missing"
        [ -f requirements.txt ] && echo "OK: requirements.txt exists" || echo "ERROR: requirements.txt missing"

    - name: Validate JSON files
      run: |
        python -m json.tool grafana_dashboard.json > /dev/null && echo "OK: Grafana dashboard JSON is valid" || echo "ERROR: Invalid JSON"
